<div style="padding: 40px; background-color: #f9f9f9; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.05);">
    <h1 style="margin-top: 0; font-size: 28px; color: #333;">{{ clase.titulo }}</h1>

    <div style="margin-top: 30px;">
        <div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; border: 1px solid #ddd;">
            <iframe 
                src="{{ clase.video_url }}"
                frameborder="0"
                allowfullscreen
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
            </iframe>
        </div>
    </div>

    <div style="margin-top: 30px;">
        <h3 style="color: #555;">ğŸ“š LECTURA</h3>
        
        {% if clase.descripcion %}
        <div style="font-size: 16px; color: #333; line-height: 1.8; margin-top: 20px; padding: 20px; background: #fafafa; border-radius: 8px;">
            {{ clase.descripcion | safe }}
        </div>
        {% else %}
        <p style="font-size: 16px; color: #555; line-height: 1.6;">
            Te animamos a ver esta clase con una actitud de oraciÃ³n. Toma notas, escucha con atenciÃ³n y permite que el SeÃ±or hable a tu corazÃ³n a travÃ©s de Su Palabra.
        </p>
        {% endif %}
        
        <!-- Materiales en PDF -->
        {% if clase.pdf_url or clase.actividad_pdf_url %}
        <div style="margin-top: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                <strong style="color: #333;">ğŸ“‹ Materiales disponibles:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    {% if clase.pdf_url %}
                    <li style="margin-bottom: 8px;">
                        <a href="{{ clase.pdf_url }}" download style="color: #667eea; text-decoration: none; font-weight: 500;">
                            ğŸ“„ GuÃ­a de Estudio - {{ clase.titulo }}.pdf
                        </a>
                    </li>
                    {% endif %}
                    {% if clase.actividad_pdf_url %}
                    <li style="margin-bottom: 8px;">
                        <a href="{{ clase.actividad_pdf_url }}" download style="color: #764ba2; text-decoration: none; font-weight: 500;">
                            âœ… Respuestas - {{ clase.titulo }}.pdf
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>

    <div style="margin-top: 20px; background-color: #eef5ff; padding: 20px; border-left: 5px solid #007bff; border-radius: 6px;">
        <strong style="color: #007bff; font-size: 18px;">âœï¸ Actividad:</strong>
        <p style="margin-top: 15px; color: #333; font-weight: 600;">Reflexiona y responde las siguientes preguntas:</p>
        <ol style="margin-top: 15px; padding-left: 25px; line-height: 2;">
            <li style="margin-bottom: 12px; color: #333;">
                <strong>Â¿CÃ³mo contradice la Biblia la idea del "Dios relojero" propuesta por el deÃ­smo?</strong>
            </li>
            <li style="margin-bottom: 12px; color: #333;">
                <strong>Â¿CuÃ¡l es la diferencia entre la revelaciÃ³n general y la revelaciÃ³n especÃ­fica?</strong>
            </li>
            <li style="margin-bottom: 12px; color: #333;">
                <strong>Â¿QuÃ© enseÃ±an Romanos 1:20 y Romanos 2:15 sobre el conocimiento de Dios accesible a toda la humanidad?</strong>
            </li>
            <li style="margin-bottom: 12px; color: #333;">
                <strong>Â¿Por quÃ© JesÃºs es la revelaciÃ³n suprema y perfecta de Dios segÃºn Hebreos 1:1â€“4?</strong>
            </li>
            <li style="margin-bottom: 12px; color: #333;">
                <strong>Â¿Por quÃ© la creaciÃ³n no es suficiente para conocer el plan de salvaciÃ³n y por quÃ© la Biblia es necesaria?</strong>
            </li>
        </ol>
        <p style="margin-top: 15px; color: #555; font-style: italic;">
            ğŸ’¡ Tip: Comparte tus respuestas con alguien mÃ¡s. La Palabra se multiplica cuando la vivimos y la compartimos con otros.
        </p>
    </div>

    <!-- BotÃ³n para marcar clase como completada -->
    <div style="margin-top: 30px; text-align: center;">
        <button id="btnCompletarClase" 
                data-curso="{{ curso_slug }}" 
                data-clase="{{ clase.slug }}"
                style="padding: 15px 40px; font-size: 16px; font-family: 'Poppins', sans-serif; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px;">
            <span id="btnTexto">âœ… Marcar como completada</span>
        </button>
    </div>
</div>

<script>
console.log('ğŸ¬ Script de clase.html cargado');
function completarClase() {
    console.log('ğŸ”¹ FunciÃ³n completarClase llamada');
    const btn = document.getElementById('btnCompletarClase');
    const btnTexto = document.getElementById('btnTexto');
    
    if (!btn) {
        console.error('âŒ BotÃ³n no encontrado');
        alert('âŒ Error: BotÃ³n no encontrado');
        return;
    }
    
    const cursoSlug = btn.getAttribute('data-curso');
    const claseSlug = btn.getAttribute('data-clase');
    
    console.log('ğŸ“¦ Datos:', { cursoSlug, claseSlug });
    
    if (!cursoSlug || !claseSlug) {
        console.error('âŒ Faltan datos del curso o clase');
        alert('âŒ Error: Faltan datos del curso o clase');
        return;
    }
    
    // Cambiar estado del botÃ³n
    btn.disabled = true;
    btnTexto.textContent = 'â³ Guardando...';
    
    console.log('ğŸš€ Enviando peticiÃ³n a API...');
    
    fetch('/api/completar-clase', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            curso_slug: cursoSlug,
            clase_slug: claseSlug
        })
    })
    .then(response => {
        console.log('ğŸ“¥ Respuesta recibida:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ğŸ“Š Datos recibidos:', data);
        if (data.success) {
            btnTexto.textContent = 'âœ… Completada';
            btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
            
            // Mostrar mensaje de Ã©xito
            alert(data.message + '\n\nğŸ“Š Progreso: ' + data.clases_completadas + '/' + data.total_clases + ' clases (' + data.porcentaje + '%)');
            
            // Actualizar el sidebar si existe
            actualizarSidebar(cursoSlug);
        } else {
            alert('âŒ ' + data.message);
            btn.disabled = false;
            btnTexto.textContent = 'âœ… Marcar como completada';
        }
    })
    .catch(error => {
        console.error('ğŸ’¥ Error completo:', error);
        alert('âŒ Error al completar la clase: ' + error.message);
        btn.disabled = false;
        btnTexto.textContent = 'âœ… Marcar como completada';
    });
}

function actualizarSidebar(cursoSlug) {
    // Recargar progreso del curso
    fetch('/api/progreso/' + cursoSlug)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar checkmarks en el sidebar
                data.clases_completadas.forEach(claseSlug => {
                    const enlaceClase = document.querySelector(`a[href*="${claseSlug}"]`);
                    if (enlaceClase && !enlaceClase.textContent.includes('âœ…')) {
                        enlaceClase.textContent = 'âœ… ' + enlaceClase.textContent.replace('â¬œ ', '');
                    }
                });
            }
        });
}

// Al cargar la pÃ¡gina, verificar si ya estÃ¡ completada y agregar event listener
(function() {
    console.log('ğŸ”§ Inicializando evento del botÃ³n...');
    
    // Esperar un momento para asegurar que el DOM estÃ© listo
    setTimeout(function() {
        const btn = document.getElementById('btnCompletarClase');
        
        if (!btn) {
            console.error('âŒ BotÃ³n btnCompletarClase no encontrado');
            return;
        }
        
        console.log('âœ… BotÃ³n encontrado, agregando event listener');
        
        // Agregar event listener al botÃ³n
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ğŸ–±ï¸ Click en el botÃ³n detectado');
            completarClase();
        });
        
        const cursoSlug = btn.getAttribute('data-curso');
        const claseSlug = btn.getAttribute('data-clase');
        
        console.log('ğŸ“‹ Curso:', cursoSlug, '- Clase:', claseSlug);
        
        if (!cursoSlug) {
            console.error('âŒ No se encontrÃ³ curso_slug');
            return;
        }
        
        // Verificar si ya estÃ¡ completada
        fetch('/api/progreso/' + cursoSlug)
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ“Š Progreso cargado:', data);
                if (data.success) {
                    if (data.clases_completadas.includes(claseSlug)) {
                        const btnTexto = document.getElementById('btnTexto');
                        btnTexto.textContent = 'âœ… Completada';
                        btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                        btn.disabled = true;
                        console.log('âœ… Clase ya estaba completada');
                    }
                }
            })
            .catch(error => {
                console.error('ğŸ’¥ Error al cargar progreso:', error);
            });
    }, 100);
})();
</script>

